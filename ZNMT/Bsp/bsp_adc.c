/*
* ADC采样
*/
#include <stc12c5a60s2.h>
#include <intrins.h>

//10K  温度传感器表
//温度-电阻值转换表,下标表示温度,下标0对应-40度,1对应-39度...,阻值单位为欧
//如果阻值大于R_T_Table[0]则温度小-40度，阻值大于R_T_Table[1]则温度小于-39度...
code const long R_T_Table[221] =
    {
        335811, 314029, 293803, 275015, 257552,     //-40~-36
        241313, 226204, 212141, 199044, 186841,     //-35~-31
        175465, 164856, 154957, 145716, 137086,     //-30~-26
        129022, 121485, 114435, 107840, 101667,     //-25~-21
        95886,  90471,  85395,  80636,  76173,      //-20~-16
        71984,  68052,  64359,  60889,  57628,      //-15~-11
        54562,  51677,  48963,  46408,  44002,      //-10~-6
        41735,  39599,  37586,  35686,  33894,      //-5~--1
        32203,  30607,  29099,  27674,  26328,      //0~4
        25055,  23851,  22712,  21634,  20614,      //5~9
        19650,  18733,  17865,  17043,  16264,      //10~14
        15524,  14823,  14157,  13525,  12925,      //15~19
        12354,  11813,  11298,  10808,  10342,      //20-24
        9900,   9470,   9061,   8672,   8302,       //25-29
        7950,   7615,   7295,   6991,   6702,       //30-34
        6425,   6162,   5911,   5672,   5443,       //35-39
        5225,   5017,   4818,   4628,   4447,       //40-44
        4274,   4108,   3950,   3799,   3654,       //45-49
        3515,   3383,   3256,   3135,   3019,       //50-54
        2907,   2801,   2699,   2601,   2507,       //55-59
        2417,   2330,   2248,   2168,   2092,       //60-64
        2019,   1949,   1881,   1817,   1754,       //65-69
        1695,   1637,   1582,   1529,   1478,       //70-74
        1429,   1382,   1336,   1293,   1251,       //75-79
        1210,   1171,   1134,   1098,   1063,       //80-84
        1029,   997,    966,    936,    907,        //85-89
        879,    852,    826,    801,    777,        //90-94
        753,    731,    709,    688,    668,        //95-99
        648,    629,    611,    593,    576,        //100-104
        560,    544,    529,    514,    499,        //105-109
        485,    472,    459,    446,    434,        //110-114
        422,    410,    399,    389,    378,        //115-119
        368,    358,    349,    340,    331,        //120-124
        322,    314,    306,    298,    290,        //125-129
        283,    275,    269,    262,    255,        //130-134
        249,    243,    237,    231,    225,        //135-139
        220,    214,    209,    204,    199,        //140-144
        194,    190,    185,    181,    177,        //145-149
        173,    168,    165,    161,    157,        //150-154
        153,    150,    147,    143,    140,        //155-159
        137,    134,    131,    128,    125,        //160-164
        122,    120,    117,    115,    112,        //165-169
        110,    107,    105,    103,    101,        //170-174
        98,     96,     94,     92,     90,         //175-179,
        89,                                         //180
    };    


/*********************************************************************************************
函数名：adcGet
作  用: 获得ADC转换值
参  数：转换通道
返回值：16bit 温度值
**********************************************************************************************/
static unsigned int adcGet(unsigned char channel)
{
	ADC_CONTR = 0x88|channel;    //开启AD转换1000 1000 即POWER SPEED1 SPEED0 ADC_FLAG   ADC_START CHS2 CHS1 CHS0 

	//要经过4个CPU时钟的延时，其值才能够保证被设置进ADC_CONTR 寄存器
	_nop_();
	_nop_(); 
	_nop_(); 
	_nop_();

	//等待转换完成
	while(!(ADC_CONTR&0x10))    
	{
	}
	
	ADC_CONTR &= 0xe7;      //关闭AD转换，ADC_FLAG位由软件清0
	
	return (ADC_RES*4+ADC_RESL);   //返回AD转换完成的10位数据(16进制)
}

/*********************************************************************************************
函数名：adcWork
作  用: 转换结果求平均
参  数：转换通道
返回值：转换结果
**********************************************************************************************/
float adcWork(unsigned char channel)
{
	float AD_val;     //定义处理后的数值AD_val为浮点数
	unsigned char i;
	
	for(i=0;i<100;i++) 
	{
		//转换100次求平均值(提高精度)
		AD_val+=adcGet(channel); 
	}
	
	AD_val/=100;
	AD_val=(AD_val*5)/1024; //AD的参考电压是单片机上的5v，所以乘5即为实际电压值
	
	return AD_val;
}

/*********************************************************************************************
函数名：adcWork
作  用: 转换结果求平均
参  数：转换通道
返回值：转换结果
**********************************************************************************************/
extern void delayMS(unsigned int tim);
void adcInit(void)
{
	P1ASF=0x43; //  0100 0011  P1.6  P1.1 P1.0作为AD
	
	ADC_RES=0;   //清零转换结果寄存器高8位
	ADC_RESL=0; //清零转换结果寄存器低2位
	ADC_CONTR=0x80;//开启AD电源
	
	delayMS(2);   //等待1ms，让AD电源稳定
}


/*********************************************************************************************
函数名：tempCalculate
作  用: 温度计算
参  数：转换通道
返回值：转换结果
**********************************************************************************************/
int tempCalculate(unsigned char channel)
{
	float tmp;
	long res; // 阻值
	int left = 0, middle, right = sizeof(R_T_Table)/sizeof(R_T_Table[0]); 

	tmp = adcWork(channel);

	if((unsigned char)tmp == 5)
	{
		tmp = 5.0;
	}

	//有adc采集的电压计算电阻值
	res = (long)((tmp*10000) /(5 - tmp));

	//二分查找
	middle = (left + right)/2;
	while(left < right)
	{
		if(res == R_T_Table[middle])
		{
			break;
		}
		else if(res < R_T_Table[middle])
		{
			left = middle + 1;
		}
		else
		{
			right = middle;
		}

		middle = (left + right) / 2;
	}

	return (middle - 40);
	
}